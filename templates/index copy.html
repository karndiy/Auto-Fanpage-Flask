<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>Auto Fanpage Flask – แดชบอร์ด</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="หน้าจอควบคุมโพสต์เพจ Facebook ด้วย Flask: ตั้งค่า โพสต์ข้อความ/วิดีโอ และตัวตั้งเวลา">
  <style>
    :root{
      --bg:#f8f9fa; --card:#ffffff; --text:#111; --muted:#666; --border:#e5e7eb; --accent:#111;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:12px 16px;z-index:10}
    .bar{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:20px}
    .help-link{display:inline-block;font-size:13px;padding:8px 10px;border:1px solid var(--border);border-radius:8px;color:#111;text-decoration:none;background:#fff}
    .help-link:hover{background:#f3f4f6}
    .layout{display:grid;grid-template-columns:minmax(280px,360px) 1fr;gap:16px;max-width:1200px;margin:16px auto;padding:0 16px 24px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .panel.left{align-self:start}
    .panel.right{min-height:300px}
    .panel h2{margin:0 0 12px;font-size:18px}
    /* Tabs */
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);margin:-4px -4px 12px;padding:4px}
    .tab{appearance:none;border:1px solid var(--border);background:#fff;color:#111;border-radius:8px;padding:8px 12px;cursor:pointer;font-size:13px}
    .tab.active{background:var(--accent);color:#fff}
    .tab-pane{display:none}
    .tab-pane.active{display:block}
    section+section{margin-top:16px}
    section h3{margin:0 0 8px;font-size:15px}
    label{display:block;margin:.5rem 0 .25rem;font-size:13px}
    input,textarea,select{width:100%;padding:10px;border:1px solid #dadce0;border-radius:8px;background:#fff}
    textarea{resize:vertical}
    .actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    button{padding:10px 14px;border:1px solid var(--border);border-radius:8px;background:var(--accent);color:#fff;cursor:pointer}
    button.secondary{background:#fff;color:#111}
    .hint{color:var(--muted);font-size:12px}
    .results .box{border:1px dashed var(--border);border-radius:8px;padding:8px 8px 0;margin:8px 0 12px;background:#fafafa}
    .results .box h4{margin:0 0 6px;font-size:13px;color:#333}
    pre{background:#111;color:#eee;padding:12px;border-radius:8px;overflow:auto;margin:0 0 8px}
    .results pre{max-height:320px}
    code{background:#f3f4f6;padding:0 4px;border-radius:4px}
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .panel{padding:12px}
      .results pre{max-height:220px}
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>Auto Fanpage Flask – แดชบอร์ด</h1>
      <a class="help-link" href="/help" title="คู่มือการใช้งาน">คู่มือการใช้งาน</a>
    </div>
  </header>

  <main class="layout">
    <!-- LEFT: Controls -->
    <div class="panel">
      <h2>การควบคุม</h2>
      <div class="tabs" role="tablist">
        <button class="tab active" role="tab" aria-selected="true" data-tab="settings" onclick="setTab('settings')">Settings</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="post_text" onclick="setTab('post_text')">Post ข้อความ</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="post_video" onclick="setTab('post_video')">Post VDO</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="scheduler" onclick="setTab('scheduler')">ตั้งค่าเวลา</button>
      </div>

      <section class="tab-pane active" data-pane="settings" aria-labelledby="sec-settings">
        <h3 id="sec-settings">การตั้งค่า Facebook</h3>
        <div class="row" style="display:grid;grid-template-columns:1fr;gap:12px">
          <div>
            <label>App ID</label><input id="app_id" placeholder="ใส่ App ID">
            <label>App Secret</label><input id="app_secret" placeholder="ใส่ App Secret">
            <label>Short-Lived User Token</label><textarea id="short_token" rows="3" placeholder="โทเค็นผู้ใช้แบบสั้น"></textarea>
            <label>Long-Lived User Token</label><textarea id="long_token" rows="3" placeholder="โทเค็นผู้ใช้แบบยาว"></textarea>
            <label>Page ID</label><input id="page_id" placeholder="ระบุ Page ID">
            <label>Page Access Token</label><textarea id="page_token" rows="3" placeholder="โทเค็นเพจ"></textarea>
          </div>
          <div>
            <label>ข้อความเริ่มต้น (Default Message)</label><textarea id="default_message" rows="3" placeholder="เช่น สวัสดีจากบอท!"></textarea>
            <label>ลิงก์เริ่มต้น (Default Link)</label><input id="default_link" placeholder="https://...">
            <label>เผยแพร่ทันที (Published)</label>
            <select id="default_published">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
            <p class="hint">แก้ไขไฟล์ <code>settings.json</code> โดยตรงก็ได้</p>
          </div>
        </div>
        <div class="actions">
          <button onclick="saveSettings()">บันทึกการตั้งค่า</button>
          <button class="secondary" onclick="exchangeUserToken()">แลกเปลี่ยนโทเค็นแบบยาว</button>
          <button class="secondary" onclick="loadPages()">โหลดเพจของฉัน</button>
          <button class="secondary" onclick="getPageToken()">รับโทเค็นเพจ</button>
        </div>
      </section>

      <section class="tab-pane" data-pane="post_text" aria-labelledby="sec-text">
        <h3 id="sec-text">โพสต์ข้อความ</h3>
        <label>ข้อความ</label><textarea id="text_message" rows="3" placeholder="พิมพ์ข้อความ (ถ้าเว้นว่างจะใช้ Default Message)"></textarea>
        <label>ลิงก์ (ถ้ามี)</label><input id="text_link" placeholder="https://...">
        <label>เผยแพร่</label>
        <select id="text_published">
          <option value="true">true</option>
          <option value="false">false</option>
        </select>
        <div class="actions"><button onclick="postText()">โพสต์ข้อความ</button></div>
      </section>

      <section class="tab-pane" data-pane="post_video" aria-labelledby="sec-video">
        <h3 id="sec-video">โพสต์วิดีโอ</h3>
        <label>คำอธิบาย</label><textarea id="video_desc" rows="3" placeholder="คำอธิบายวิดีโอ"></textarea>
        <label>ไฟล์วิดีโอ</label><input id="video_file" type="file" accept="video/*">
        <label>หรือ ระบุเส้นทางไฟล์บนเซิร์ฟเวอร์</label><input id="video_path" placeholder="เช่น C:\\videos\\clip.mp4 หรือ /path/video.mp4">
        <div class="actions"><button onclick="postVideo()">โพสต์วิดีโอ</button></div>
      </section>

      <section class="tab-pane" data-pane="scheduler" aria-labelledby="sec-sched">
        <h3 id="sec-sched">ตัวตั้งเวลา (Scheduler)</h3>
        <div class="actions">
          <button onclick="toggleScheduler(true)">เปิดใช้งาน</button>
          <button class="secondary" onclick="toggleScheduler(false)">ปิดใช้งาน</button>
          <button class="secondary" onclick="reloadJobs()">โหลดงานใหม่</button>
        </div>
      </section>
    </div>

    <!-- RIGHT: Results -->
    <div class="panel results">
      <h2>การแสดงผล</h2>
      <div class="box">
        <h4>ผลลัพธ์การตั้งค่า/โทเค็น</h4>
        <pre id="out_settings" aria-live="polite"></pre>
      </div>
      <div class="box">
        <h4>ผลลัพธ์โพสต์ข้อความ</h4>
        <pre id="out_text" aria-live="polite"></pre>
      </div>
      <div class="box">
        <h4>ผลลัพธ์โพสต์วิดีโอ</h4>
        <pre id="out_video" aria-live="polite"></pre>
      </div>
      <div class="box">
        <h4>ผลลัพธ์ตัวตั้งเวลา</h4>
        <pre id="out_sched" aria-live="polite"></pre>
      </div>
    </div>
  </main>

  <script>
function setTab(name){
  document.querySelectorAll('.tab').forEach(b=>{
    const active = b.getAttribute('data-tab')===name;
    b.classList.toggle('active', active);
    b.setAttribute('aria-selected', active? 'true':'false');
  });
  document.querySelectorAll('.tab-pane').forEach(p=>{
    p.classList.toggle('active', p.getAttribute('data-pane')===name);
  });
}

async function loadSettings(){
  const r = await fetch('/api/settings');
  const s = await r.json();
  app_id.value = s.app_id || '';
  app_secret.value = s.app_secret || '';
  short_token.value = s.short_lived_user_token || '';
  long_token.value = s.long_lived_user_token || '';
  page_id.value = s.page_id || '';
  page_token.value = s.page_access_token || '';
  default_message.value = s.default_message || '';
  default_link.value = (s.post_defaults && s.post_defaults.link) || '';
  default_published.value = (s.post_defaults && s.post_defaults.published) ? 'true' : 'false';
  out_settings.textContent = JSON.stringify(s, null, 2);
}
async function saveSettings(){
  const payload = {
    app_id: app_id.value, app_secret: app_secret.value,
    short_lived_user_token: short_token.value,
    long_lived_user_token: long_token.value,
    page_id: page_id.value,
    page_access_token: page_token.value,
    default_message: default_message.value,
    post_defaults: { link: default_link.value, published: default_published.value === 'true' }
  };
  const r = await fetch('/api/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  out_settings.textContent = JSON.stringify(await r.json(), null, 2);
}
async function exchangeUserToken(){
  const r = await fetch('/api/exchange_user_token', {method:'POST'});
  out_settings.textContent = JSON.stringify(await r.json(), null, 2);
  loadSettings();
}
async function loadPages(){
  const r = await fetch('/api/pages');
  out_settings.textContent = JSON.stringify(await r.json(), null, 2);
}
async function getPageToken(){
  const r = await fetch('/api/page_token', {method:'POST'});
  out_settings.textContent = JSON.stringify(await r.json(), null, 2);
  loadSettings();
}
async function postText(){
  const payload = {
    message: text_message.value || default_message.value,
    link: text_link.value || default_link.value,
    published: text_published.value === 'true'
  };
  const r = await fetch('/api/post_text', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  out_text.textContent = JSON.stringify(await r.json(), null, 2);
}
async function postVideo(){
  const fd = new FormData();
  fd.append('description', video_desc.value || '');
  if(video_file.files[0]) fd.append('file', video_file.files[0]);
  if(video_path.value) fd.append('video_path', video_path.value);
  const r = await fetch('/api/post_video', {method:'POST', body: fd});
  out_video.textContent = JSON.stringify(await r.json(), null, 2);
}
async function toggleScheduler(enabled){
  const r = await fetch('/api/scheduler/toggle', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({enabled})});
  out_sched.textContent = JSON.stringify(await r.json(), null, 2);
}
async function reloadJobs(){
  const r = await fetch('/api/scheduler/reload', {method:'POST'});
  out_sched.textContent = JSON.stringify(await r.json(), null, 2);
}
// default tab
setTab('settings');
loadSettings();
  </script>
</body>
</html>
